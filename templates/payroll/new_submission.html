{% extends "base.html" %}
{% block content %}
<h4>New Payroll Submission</h4>
<form method="post">
  {% csrf_token %}
  
  <div class="mb-3">
    {{ sub_form.payroll_month.label_tag }} {{ sub_form.payroll_month }}
  </div>

  <!-- ✅ Management form must be outside the table -->
  {{ formset.management_form }}

  <table class="table table-bordered" id="entry-table">
    <thead>
      <tr>
        <th>Employee ID</th><th>Name</th><th>Grade</th><th>Location</th>
        <th>Payroll Name</th><th>Days</th><th>Per Day</th><th>Final Amount</th>
        <th>Holiday</th><th>Function Name</th><th>Line Manager</th>
        <th>Function Manager</th><th>Functional Head</th><th>Remarks</th><th></th>
      </tr>
    </thead>
    <tbody>
      {% for form in formset %}
      <tr class="entry-row">
        <td>{{ form.employee_id }}</td>
        <td>{{ form.name }}</td>
        <td>{{ form.grade }}</td>
        <td>{{ form.location }}</td>
        <td>{{ form.payroll_name }}</td>
        <td>{{ form.days }}</td>
        <td>{{ form.per_day }}</td>
        <td>{{ form.final_amount }}</td>
        <td>{{ form.holiday }}</td>
        <td>{{ form.function_name }}</td>
        <td>{{ form.line_manager }}</td>
        <td>{{ form.function_manager }}</td>
        <td>{{ form.functional_head }}</td>
        <td>{{ form.remarks }}</td>
        <td><button type="button" class="btn btn-sm btn-outline-danger remove-row">Delete</button></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <button type="button" id="add-row" class="btn btn-outline-primary">+ Add Row</button>
  <button type="submit" class="btn btn-success">Submit</button>
</form>

<script>
(function(){
  const addBtn = document.getElementById('add-row');
  const tableBody = document.querySelector('#entry-table tbody');
  const totalForms = document.querySelector('#id_form-TOTAL_FORMS');

  // ✅ NEW: function to reindex all rows after add/remove
  function reindexRows(){
    const rows = document.querySelectorAll('.entry-row');
    rows.forEach((row, index) => {
      row.querySelectorAll('input, select, textarea').forEach((el) => {
        el.name = el.name.replace(/form-(\d+)-/, `form-${index}-`);
        el.id = el.id.replace(/id_form-(\d+)-/, `id_form-${index}-`);
      });
    });
    totalForms.value = rows.length;  // ✅ keep TOTAL_FORMS in sync
  }

  function cloneRow(){
    const template = tableBody.querySelector('.entry-row').cloneNode(true);

    // ✅ NEW: clear values and hidden IDs
    template.querySelectorAll('input, select, textarea').forEach((el)=>{
      if(el.type === 'checkbox'){ 
        el.checked = false; 
      } else { 
        el.value = ''; 
      }
    });

    tableBody.appendChild(template);
    reindexRows();  // ✅ ensure indices and TOTAL_FORMS are updated
  }

  addBtn.addEventListener('click', cloneRow);

  tableBody.addEventListener('click', function(e){
    if(e.target.classList.contains('remove-row')){
      const rows = document.querySelectorAll('.entry-row');
      if(rows.length > 1){
        e.target.closest('tr').remove();
        reindexRows();  // ✅ reindex after removal
      }
    }
  });

  tableBody.addEventListener('input', function(e){
    const row = e.target.closest('tr');
    const days = parseFloat(row.querySelector('[name$="days"]').value) || 0;
    const perDay = parseFloat(row.querySelector('[name$="per_day"]').value) || 0;
    const final = row.querySelector('[name$="final_amount"]');
    final.value = (days * perDay).toFixed(2);
  });
})();
</script>
{% endblock %}
